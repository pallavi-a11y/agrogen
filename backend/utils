from pymongo import MongoClient
import os
from bson import ObjectId
from decouple import config

# ✅ MongoDB Connection
MONGO_URL = os.getenv("MONGO_URL", "mongodb://localhost:27017/")
client = MongoClient(MONGO_URL)
db = client["smartfarm"]

# ✅ Define the sensor collection
sensor_collection = db["sensor_data"]

def get_latest_sensor_data():
    """
    Fetch the most recent IoT sensor data document from MongoDB.
    """
    latest = sensor_collection.find_one(sort=[("_id", -1)])
    if not latest:
        return None

    # Convert ObjectId to string for JSON serialization
    latest["_id"] = str(latest["_id"])

    # ✅ Return cleaned data
    return {
        "N": latest.get("N", 0),
        "P": latest.get("P", 0),
        "K": latest.get("K", 0),
        "pH": latest.get("pH", 7),
        "temperature": latest.get("temperature", 25),
        "humidity": latest.get("humidity", 50),
    }
